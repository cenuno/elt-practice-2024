---
name: Lint and Test
on:  # yamllint disable-line rule:truthy
  pull_request:
    branches:
      - main
      - staging
      - 'release/**'
jobs:
  lint_and_test:
    runs-on: ubuntu-latest
    steps:
      # ----------------------------------------------
      # ----- check-out repo and set-up python -----
      # ----------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.5'
          architecture: 'x64'
      # ----------------------------------------------
      # -----  load cached poetry installation  -----
      # ----------------------------------------------
      - name: Load cached Poetry installation
        id: cached-poetry
        uses: actions/cache@v4
        with:
          path: ~/.local  # the path depends on the OS
          key: poetry-0  # increment to reset cache
      # ----------------------------------------------
      # -----  install & configure poetry  -----
      # ----------------------------------------------
      - name: Install Poetry
        if: steps.cached-poetry.outputs.cache-hit != 'true'
        uses: snok/install-poetry@v1
        with:
          version: 1.8.3
          virtualenvs-create: true
          virtualenvs-in-project: false
          installer-parallel: true
          # NOTE: export plugin is already explicitly installed
          warnings-export: false
      - name: Install dependencies via poetry
        run: |
          poetry install --no-interaction --compile --no-root --only main
      - name: Run linters
        run: |
          poetry run hadolint Dockerfile.python
          poetry run yamllint .
          poetry run flake8 .
          poetry run vulture .
          poetry run black . --check
      - name: Run tests
        run: |
          poetry run pytest .
